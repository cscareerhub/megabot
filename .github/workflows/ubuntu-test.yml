name: CI

on: push

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    env:
      RUST_BACKTRACE: full
      RUSTC_WRAPPER: sccache
      SCCACHE_CACHE_SIZE: 2G
      SCCACHE_DIR: /home/runner/.cache/sccache
      # SCCACHE_RECACHE: 1 # Uncomment this to clear cache, then comment it back out
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v2

      - name: Install sccache (ubuntu-latest)
        env:
          LINK: https://github.com/mozilla/sccache/releases/download
          SCCACHE_VERSION: v0.3.0
        run: |
          SCCACHE_FILE=sccache-$SCCACHE_VERSION-x86_64-unknown-linux-musl
          mkdir -p $HOME/.local/bin
          wget "$LINK/$SCCACHE_VERSION/$SCCACHE_FILE.tar.gz"
          echo e6cd8485f93d683a49c83796b9986f090901765aa4feb40d191b03ea770311d8 "$SCCACHE_FILE.tar.gz" | sha256sum --check
          tar zxfv "$SCCACHE_FILE.tar.gz"
          mv -f $SCCACHE_FILE/sccache $HOME/.local/bin/sccache
          sudo chmod +x $HOME/.local/bin/sccache
          echo "$HOME/.local/bin" >> $GITHUB_PATH 

      - name: Install 1.66 toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.66.0
          components: rustfmt, clippy

      - name: Cache rust
        uses: Swatinem/rust-cache@v1
        with:
          # increment this to bust the github actions cache if needed
          key: v1

      - name: Run cargo fmt
        run: cargo fmt --all -- --check

      - name: Run cargo check
        run: cargo check

      - name: Run cargo clippy
        run: cargo clippy -- --deny warnings

      - name: Run cargo test
        run: cargo test

      - name: sccache stats
        id: stats_clippy
        run: |
          sccache --show-stats

